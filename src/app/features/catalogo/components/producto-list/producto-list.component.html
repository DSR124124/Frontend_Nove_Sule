<div class="producto-list-container">
  <!-- Header con acciones -->
  <div class="list-header">
    <div class="header-left">
      <h2 class="heading-2">Lista de Productos</h2>
      <span class="text-caption">{{totalElements}} productos</span>
    </div>
    <div class="header-actions">
      <p-button
        (onClick)="onRefresh()"
        [disabled]="loading"
        label="Actualizar"
        icon="pi pi-refresh"
        styleClass="btn-secondary btn-outlined btn-sm"
        [loading]="loading">
      </p-button>
      <p-button
        routerLink="/catalogo/productos/nuevo"
        label="Nuevo Producto"
        icon="pi pi-plus"
        styleClass="btn-primary btn-sm">
      </p-button>
    </div>
  </div>

  <!-- Panel de búsqueda y filtros -->
  <p-panel
    header="Búsqueda y Filtros"
    [toggleable]="true"
    [collapsed]="true"
    styleClass="filters-panel">
    <ng-template pTemplate="header">
      <div class="panel-header">
        <i class="pi pi-search"></i>
        <span>Búsqueda y Filtros</span>
        <i class="pi pi-chevron-down"></i>
      </div>
    </ng-template>

    <!-- Componente de búsqueda -->
    <app-producto-search
      (searchEvent)="onSearch($event)"
      (clearEvent)="onClearSearch()">
    </app-producto-search>
  </p-panel>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" styleClass="custom-spinner"
      ariaLabel="Cargando productos">
    </p-progressSpinner>
    <p class="text-body">Cargando productos...</p>
  </div>

  <!-- Tabla de productos -->
  <p-table
    [value]="productos"
    [loading]="loading"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="totalElements"
    [first]="currentPage * pageSize"
    (onPage)="onPageChange($event)"
    styleClass="p-datatable-sm products-table"
    [rowHover]="true"
    dataKey="id">

    <!-- Columnas de la tabla -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">ID</th>
        <th style="width: 4rem">Código</th>
        <th>Producto</th>
        <th style="width: 6rem">Categoría</th>
        <th style="width: 6rem">Marca</th>
        <th style="width: 6rem">Proveedor</th>
        <th style="width: 6rem">Precio Venta</th>
        <th style="width: 6rem">Precio Compra</th>
        <th style="width: 5rem">Stock</th>
        <th style="width: 5rem">Estado</th>
        <th style="width: 8rem">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-producto>
      <tr [routerLink]="['/catalogo/productos/editar', producto.id]" style="cursor: pointer;">
        <td>
          <span class="text-caption">{{producto.id}}</span>
        </td>
        <td>
          <span class="text-body font-mono">{{producto.codigo}}</span>
        </td>
        <td>
          <div class="producto-info">
            <div class="producto-name">{{producto.nombre}}</div>
            <div class="producto-desc text-caption" *ngIf="producto.descripcion">
              {{producto.descripcion | slice:0:50}}{{producto.descripcion.length > 50 ? '...' : ''}}
            </div>
          </div>
        </td>
        <td>
          <span class="text-body">{{producto.categoria.nombre}}</span>
        </td>
        <td>
          <span class="text-body">{{producto.marca.nombre}}</span>
        </td>
        <td>
          <span class="text-body">{{producto.proveedor.nombre}}</span>
        </td>
        <td>
          <span class="text-body font-semibold text-success">
            S/ {{producto.precio | number:'1.2-2'}}
          </span>
        </td>
        <td>
          <span class="text-body text-muted">
            S/ {{producto.precioCompra | number:'1.2-2'}}
          </span>
        </td>
        <td>
          <div class="stock-info">
            <div class="stock-value" [ngClass]="producto.stock === 0 ? 'text-error' : producto.stock <= producto.stockMinimo ? 'text-warning' : 'text-success'">
              {{producto.stock}}
            </div>
            <div class="stock-min text-caption">Mín: {{producto.stockMinimo}}</div>
          </div>
        </td>
        <td>
          <p-tag
            [value]="producto.estado"
            [styleClass]="getEstadoStyleClass(producto.estado)"
            [rounded]="true">
          </p-tag>
        </td>
        <td>
          <div class="table-actions" (click)="$event.stopPropagation()">
            <p-button
              icon="pi pi-eye"
              styleClass="btn-secondary btn-outlined btn-sm btn-text"
              pTooltip="Ver detalles"
              tooltipPosition="top"
              (onClick)="onVerDetalles(producto)">
            </p-button>
            <p-button
              icon="pi pi-pencil"
              styleClass="btn-warning btn-outlined btn-sm btn-text"
              pTooltip="Editar"
              tooltipPosition="top"
              [routerLink]="['/catalogo/productos/editar', producto.id]"
              (click)="$event.stopPropagation()">
            </p-button>
            <p-button
              icon="pi pi-box"
              styleClass="btn-info btn-outlined btn-sm btn-text"
              pTooltip="Gestionar stock"
              tooltipPosition="top">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="11" class="text-center">
          <div class="no-products-content">
            <i class="pi pi-box text-6xl text-muted"></i>
            <h3 class="heading-3">No hay productos</h3>
            <p class="text-body">No se encontraron productos con los filtros aplicados.</p>
            <p-button
              (onClick)="onClearSearch()"
              label="Limpiar Filtros"
              icon="pi pi-refresh"
              styleClass="btn-primary btn-sm">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Diálogo de detalles del producto -->
  <app-producto-detail-dialog
    [(visible)]="showDetailsDialog"
    [producto]="selectedProducto"
    [loading]="loading"
    (visibleChange)="onCerrarDetalles()"
    (edit)="onEditProducto($event)">
  </app-producto-detail-dialog>
</div>
