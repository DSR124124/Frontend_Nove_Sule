<div class="p-fluid">
  <p-card header="Historial de Stock">
    <p-toolbar>
      <ng-template pTemplate="left">
        <h5>Historial de Movimientos de Stock</h5>
      </ng-template>
      <ng-template pTemplate="right">
        <p-button
          label="Exportar Excel"
          icon="pi pi-file-excel"
          (onClick)="exportarExcel()"
          styleClass="btn btn-success mr-2">
        </p-button>
        <p-button
          label="Exportar PDF"
          icon="pi pi-file-pdf"
          (onClick)="exportarPDF()"
          styleClass="btn btn-export">
        </p-button>
      </ng-template>
    </p-toolbar>

    <!-- Filtros de bÃºsqueda -->
    <div class="filtros-section mb-4">
      <div class="filtros-container">
        <div class="filtro-item">
          <label for="producto" class="form-label">Producto</label>
          <p-autoComplete
            id="producto"
            [(ngModel)]="productoSeleccionado"
            [suggestions]="productos"
            (completeMethod)="cargarProductos()"
            (onSelect)="onProductoSelect($event)"
            field="nombre"
            placeholder="Seleccionar producto"
            [dropdown]="true"
            class="w-100">
          </p-autoComplete>
        </div>
        <div class="filtro-item">
          <label for="fechaInicio" class="form-label">Fecha Inicio</label>
          <input
            type="date"
            id="fechaInicio"
            [(ngModel)]="fechaInicioInput"
            (change)="onFechaInicioChange()"
            class="p-inputtext p-component w-100"
            pInputText>
        </div>
        <div class="filtro-item">
          <label for="fechaFin" class="form-label">Fecha Fin</label>
          <input
            type="date"
            id="fechaFin"
            [(ngModel)]="fechaFinInput"
            (change)="onFechaFinChange()"
            class="p-inputtext p-component w-100"
            pInputText>
        </div>
        <div class="filtro-item">
          <p-button
            label="Buscar"
            icon="pi pi-search"
            (onClick)="buscarHistorial()"
            [loading]="loading"
            styleClass="btn btn-primary w-100">
          </p-button>
        </div>
      </div>
    </div>

    <p-table
      [value]="movimientos"
      [loading]="loading"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} movimientos"
      [rowsPerPageOptions]="[10, 25, 50]"
      [globalFilterFields]="['concepto', 'observaciones']"
      #dt>

      <ng-template pTemplate="caption">
        <div class="flex justify-content-between align-items-center">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input
              pInputText
              type="text"
              placeholder="Buscar movimientos..."
              (input)="onFilterGlobal($event, dt)"
              class="p-inputtext-sm">
          </span>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Cantidad</th>
          <th>Stock Anterior</th>
          <th>Stock Nuevo</th>
          <th>Precio Unitario</th>
          <th>Concepto</th>
          <th>Observaciones</th>
          <th>Usuario</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-movimiento>
        <tr>
          <td>{{ formatDateTime(movimiento.fechaMovimiento) }}</td>
          <td>
              <p-tag
                [value]="movimiento.tipoMovimiento"
                [styleClass]="getSeverityClass(movimiento.tipoMovimiento)">
              </p-tag>
          </td>
          <td>
            <span [style.color]="movimiento.tipoMovimiento === 'ENTRADA' ? 'var(--success)' : 'var(--error)'" class="font-semibold">
              {{ movimiento.tipoMovimiento === 'ENTRADA' ? '+' : '-' }}{{ movimiento.cantidad }}
            </span>
          </td>
          <td>{{ movimiento.stockAnterior }}</td>
          <td>
            <span class="font-semibold">{{ movimiento.stockNuevo }}</span>
          </td>
          <td>{{ formatCurrency(movimiento.precioUnitario) }}</td>
          <td>{{ movimiento.concepto }}</td>
          <td>{{ movimiento.observaciones || 'N/A' }}</td>
          <td>{{ movimiento.usuario?.nombre || 'N/A' }}</td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center">
            <div class="flex flex-column align-items-center py-4">
              <i class="pi pi-inbox text-4xl mb-3" style="color: var(--text-muted);"></i>
              <span style="color: var(--text-secondary);">No se encontraron movimientos</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<p-toast></p-toast>
