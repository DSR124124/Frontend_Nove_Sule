<div class="p-fluid">
  <p-card header="Reporte de Movimientos de Inventario" subHeader="Generar reportes de movimientos con filtros avanzados">

    <!-- Filtros -->
    <div class="filtros-section mb-4">
      <p-toolbar>
        <ng-template pTemplate="left">
          <h5>Filtros de BÃºsqueda</h5>
        </ng-template>
        <ng-template pTemplate="right">
          <p-button
            label="Limpiar"
            icon="pi pi-refresh"
            styleClass="btn btn-secondary me-2"
            (onClick)="limpiarFiltros()">
          </p-button>
          <p-button
            label="Generar Reporte"
            icon="pi pi-search"
            styleClass="btn btn-primary"
            (onClick)="generarReporte()"
            [loading]="loading">
          </p-button>
        </ng-template>
      </p-toolbar>

      <div class="filtros-container">
        <div class="filtro-item">
          <label for="producto" class="form-label">Producto</label>
          <p-autoComplete
            id="producto"
            [(ngModel)]="productoSeleccionado"
            [suggestions]="productos"
            (completeMethod)="cargarProductos()"
            (onSelect)="onProductoSelect($event)"
            field="nombre"
            placeholder="Buscar producto..."
            [dropdown]="true"
            class="w-100">
            <ng-template let-producto pTemplate="item">
              <div class="flex align-items-center">
                <span class="fw-bold">{{producto.codigo}}</span> - {{producto.nombre}}
              </div>
            </ng-template>
          </p-autoComplete>
        </div>

        <div class="filtro-item">
          <label for="tipoMovimiento" class="form-label">Tipo de Movimiento</label>
          <p-select
            id="tipoMovimiento"
            [(ngModel)]="tipoMovimiento"
            [options]="tiposMovimiento"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar tipo"
            class="w-100">
          </p-select>
        </div>

        <div class="filtro-item">
          <label for="fechaInicio" class="form-label">Fecha Inicio</label>
          <input
            type="date"
            id="fechaInicio"
            [(ngModel)]="fechaInicioInput"
            (change)="onFechaInicioChange()"
            class="p-inputtext p-component w-100"
            pInputText>
        </div>

        <div class="filtro-item">
          <label for="fechaFin" class="form-label">Fecha Fin</label>
          <input
            type="date"
            id="fechaFin"
            [(ngModel)]="fechaFinInput"
            (change)="onFechaFinChange()"
            class="p-inputtext p-component w-100"
            pInputText>
        </div>
      </div>
    </div>

        <!-- Resultados -->
        <div class="resultados-section" *ngIf="movimientos.length > 0">
          <p-toolbar>
            <ng-template pTemplate="left">
              <h6>Resultados ({{movimientos.length}} registros)</h6>
            </ng-template>
            <ng-template pTemplate="right">
              <p-button
                label="Exportar Excel"
                icon="pi pi-file-excel"
                styleClass="btn btn-success me-2"
                (onClick)="exportarExcel()">
              </p-button>
              <p-button
                label="Exportar PDF"
                icon="pi pi-file-pdf"
                styleClass="btn btn-export"
                (onClick)="exportarPDF()">
              </p-button>
            </ng-template>
          </p-toolbar>

          <p-table
            [value]="movimientos"
            [loading]="loading"
            [paginator]="true"
            [rows]="10"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
            [rowsPerPageOptions]="[10, 25, 50]"
            styleClass="p-datatable-sm"
            responsiveLayout="scroll">

            <ng-template pTemplate="header">
              <tr>
                <th>Fecha</th>
                <th>Producto</th>
                <th>Tipo</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
                <th>Total</th>
                <th>Motivo</th>
                <th>Usuario</th>
                <th>Observaciones</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-movimiento>
              <tr>
                <td>{{formatDateTime(movimiento.fechaMovimiento)}}</td>
                <td>
                  <div>
                    <strong>{{movimiento.producto.codigo}}</strong><br>
                    <small>{{movimiento.producto.nombre}}</small>
                  </div>
                </td>
                <td>
                  <p-tag
                    [value]="movimiento.tipoMovimiento"
                    [styleClass]="getSeverityClass(movimiento.tipoMovimiento)">
                  </p-tag>
                </td>
                <td>
                  <span [style.color]="movimiento.tipoMovimiento === 'ENTRADA' ? 'var(--success)' : 'var(--error)'">
                    {{movimiento.tipoMovimiento === 'ENTRADA' ? '+' : '-'}}{{movimiento.cantidad}}
                  </span>
                </td>
                <td>{{formatCurrency(movimiento.precioUnitario)}}</td>
                <td>{{formatCurrency(movimiento.total)}}</td>
                <td>{{movimiento.motivo}}</td>
                <td>{{movimiento.usuario.nombre}}</td>
                <td>{{movimiento.observaciones || 'N/A'}}</td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="9" class="text-center">
                  <div class="p-4">
                    <i class="pi pi-info-circle" style="font-size: 2rem; color: var(--text-muted);"></i>
                    <p class="mt-2" style="color: var(--text-muted);">No se encontraron movimientos con los filtros aplicados</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div *ngIf="!loading && movimientos.length === 0" class="text-center p-4">
          <i class="pi pi-search" style="font-size: 3rem; color: var(--text-muted);"></i>
          <h5 class="mt-3" style="color: var(--text-muted);">No hay datos para mostrar</h5>
          <p style="color: var(--text-muted);">Aplique filtros y genere un reporte para ver los movimientos</p>
        </div>

      </p-card>
</div>

