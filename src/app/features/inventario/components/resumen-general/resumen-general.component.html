<div class="p-fluid">
  <!-- Header -->
  <p-toolbar styleClass="mb-4">
    <ng-template pTemplate="left">
      <div class="toolbar-left">
        <p-avatar icon="pi pi-chart-bar" styleClass="mr-2"></p-avatar>
        <span class="toolbar-title">Resumen General del Inventario</span>
      </div>
    </ng-template>
    <ng-template pTemplate="right">
      <p-button
        icon="pi pi-refresh"
        (onClick)="cargarResumenGeneral()"
        [loading]="loading"
        styleClass="p-button-text"
        pTooltip="Actualizar datos">
      </p-button>
    </ng-template>
  </p-toolbar>

  <!-- Filtros -->
  <p-card styleClass="filters-card mb-4">
    <ng-template pTemplate="header">
      <div class="card-header">
        <p-avatar icon="pi pi-filter" styleClass="mr-2"></p-avatar>
        <span>Filtros y Acciones</span>
      </div>
    </ng-template>

    <div class="p-grid p-align-end">
      <div class="p-col-12 p-md-4">
        <label for="fecha" class="block mb-2">Fecha de Consulta</label>
        <input
          type="date"
          id="fecha"
          [(ngModel)]="fechaInput"
          (change)="onFechaChange()"
          class="p-inputtext p-component w-full"
          pInputText>
      </div>

      <div class="p-col-12 p-md-4">
        <p-button
          label="Actualizar"
          icon="pi pi-refresh"
          (onClick)="cargarResumenGeneral()"
          [loading]="loading"
          styleClass="p-button-primary w-full">
        </p-button>
      </div>

      <div class="p-col-12 p-md-4">
        <p-button
          label="Exportar PDF"
          icon="pi pi-file-pdf"
          styleClass="p-button-outlined w-full"
          (onClick)="exportarPDF()">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Contenido Principal -->
  <div *ngIf="resumenGeneral && !loading">

    <!-- Métricas Principales -->
    <p-card styleClass="metrics-panel mb-4">
      <ng-template pTemplate="header">
        <div class="card-header">
          <p-avatar icon="pi pi-chart-line" styleClass="mr-2"></p-avatar>
          <span>Métricas Principales</span>
        </div>
      </ng-template>

      <div class="p-grid">
        <!-- Total Productos -->
        <div class="p-col-12 p-md-6 p-lg-3">
          <p-card styleClass="metric-card primary-metric">
            <ng-template pTemplate="header">
              <div class="metric-header">
                <p-avatar icon="pi pi-box" size="xlarge" styleClass="metric-avatar primary-avatar"></p-avatar>
              </div>
            </ng-template>
            <div class="metric-body">
              <div class="metric-value">{{resumenGeneral.totalProductos}}</div>
              <div class="metric-label">Total Productos</div>
            </div>
          </p-card>
        </div>

        <!-- Stock Bajo -->
        <div class="p-col-12 p-md-6 p-lg-3">
          <p-card styleClass="metric-card warning-metric">
            <ng-template pTemplate="header">
              <div class="metric-header">
                <p-avatar icon="pi pi-exclamation-triangle" size="xlarge" styleClass="metric-avatar warning-avatar"></p-avatar>
              </div>
            </ng-template>
            <div class="metric-body">
              <div class="metric-value">{{resumenGeneral.productosConStockBajo}}</div>
              <div class="metric-label">Stock Bajo</div>
              <p-tag
                [value]="getSeverityText((resumenGeneral.productosConStockBajo / resumenGeneral.totalProductos) * 100)"
                [styleClass]="getSeverityClass((resumenGeneral.productosConStockBajo / resumenGeneral.totalProductos) * 100)">
              </p-tag>
            </div>
          </p-card>
        </div>

        <!-- Próximos a Vencer -->
        <div class="p-col-12 p-md-6 p-lg-3">
          <p-card styleClass="metric-card info-metric">
            <ng-template pTemplate="header">
              <div class="metric-header">
                <p-avatar icon="pi pi-clock" size="xlarge" styleClass="metric-avatar info-avatar"></p-avatar>
              </div>
            </ng-template>
            <div class="metric-body">
              <div class="metric-value">{{resumenGeneral.productosProximosVencer}}</div>
              <div class="metric-label">Próximos a Vencer</div>
            </div>
          </p-card>
        </div>

        <!-- Valor Total -->
        <div class="p-col-12 p-md-6 p-lg-3">
          <p-card styleClass="metric-card success-metric">
            <ng-template pTemplate="header">
              <div class="metric-header">
                <p-avatar icon="pi pi-wallet" size="xlarge" styleClass="metric-avatar success-avatar"></p-avatar>
              </div>
            </ng-template>
            <div class="metric-body">
              <div class="metric-value currency-value">{{formatCurrency(resumenGeneral.valorTotalInventario)}}</div>
              <div class="metric-label">Valor Total</div>
            </div>
          </p-card>
        </div>
      </div>
    </p-card>

    <!-- Estadísticas -->
    <div class="p-grid">
      <!-- Movimientos del Mes -->
      <div class="p-col-12 p-md-6">
        <p-card styleClass="stats-card">
          <ng-template pTemplate="header">
            <div class="stats-header">
              <p-avatar icon="pi pi-arrows-v" styleClass="stats-avatar movements-avatar"></p-avatar>
              <div class="stats-title">
                <h3>Movimientos del Mes</h3>
                <p>Entradas y Salidas</p>
              </div>
            </div>
          </ng-template>

          <div class="stats-content">
            <div class="p-grid">
              <div class="p-col-6">
                <div class="stat-display success">
                  <p-avatar icon="pi pi-arrow-up" styleClass="stat-avatar success-avatar"></p-avatar>
                  <div class="stat-info">
                    <div class="stat-number">{{resumenGeneral.totalEntradasMes}}</div>
                    <div class="stat-text">Entradas</div>
                  </div>
                </div>
              </div>

              <div class="p-col-6">
                <div class="stat-display danger">
                  <p-avatar icon="pi pi-arrow-down" styleClass="stat-avatar danger-avatar"></p-avatar>
                  <div class="stat-info">
                    <div class="stat-number">{{resumenGeneral.totalSalidasMes}}</div>
                    <div class="stat-text">Salidas</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Estado del Inventario -->
      <div class="p-col-12 p-md-6">
        <p-card styleClass="stats-card">
          <ng-template pTemplate="header">
            <div class="stats-header">
              <p-avatar icon="pi pi-info-circle" styleClass="stats-avatar info-avatar"></p-avatar>
              <div class="stats-title">
                <h3>Estado General</h3>
                <p>Información del Sistema</p>
              </div>
            </div>
          </ng-template>

          <div class="stats-content">
            <div class="stat-display secondary">
              <p-avatar icon="pi pi-pause" styleClass="stat-avatar secondary-avatar"></p-avatar>
              <div class="stat-info">
                <div class="stat-number">{{resumenGeneral.productosSinMovimientos}}</div>
                <div class="stat-text">Sin Movimientos</div>
              </div>
            </div>

            <p-divider></p-divider>

            <div class="update-section">
              <div class="update-content">
                <p-avatar icon="pi pi-sync" styleClass="update-avatar"></p-avatar>
                <div>
                  <div class="stat-text">Última Actualización</div>
                  <div class="update-date">{{formatDate(resumenGeneral.ultimaActualizacion)}}</div>
                </div>
              </div>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Alertas -->
    <p-card styleClass="alerts-panel mb-4">
      <ng-template pTemplate="header">
        <div class="card-header">
          <p-avatar icon="pi pi-bell" styleClass="mr-2"></p-avatar>
          <span>Alertas del Sistema</span>
        </div>
      </ng-template>

      <div class="alerts-content">
        <!-- Stock Bajo -->
        <p-message
          *ngIf="resumenGeneral.productosConStockBajo > 0"
          severity="warn"
          [text]="resumenGeneral.productosConStockBajo + ' productos tienen stock bajo'"
          [closable]="false"
          styleClass="mb-3">
        </p-message>

        <!-- Próximos a Vencer -->
        <p-message
          *ngIf="resumenGeneral.productosProximosVencer > 0"
          severity="info"
          [text]="resumenGeneral.productosProximosVencer + ' productos próximos a vencer'"
          [closable]="false"
          styleClass="mb-3">
        </p-message>

        <!-- Sin Movimientos -->
        <p-message
          *ngIf="resumenGeneral.productosSinMovimientos > 0"
          severity="secondary"
          [text]="resumenGeneral.productosSinMovimientos + ' productos sin movimientos recientes'"
          [closable]="false"
          styleClass="mb-3">
        </p-message>

        <!-- Estado Óptimo -->
        <p-message
          *ngIf="resumenGeneral.productosConStockBajo === 0 && resumenGeneral.productosProximosVencer === 0"
          severity="success"
          text="¡Excelente! El inventario se encuentra en buen estado"
          [closable]="false">
        </p-message>

        <!-- Mensaje por defecto si no hay datos de alertas -->
        <p-message
          *ngIf="!resumenGeneral.productosConStockBajo && !resumenGeneral.productosProximosVencer && !resumenGeneral.productosSinMovimientos"
          severity="info"
          text="No hay alertas pendientes"
          [closable]="false">
        </p-message>
      </div>
    </p-card>
  </div>

  <!-- Estado de Carga -->
  <p-card *ngIf="loading" styleClass="loading-panel text-center">
    <div class="py-6">
      <p-progressSpinner styleClass="mb-3"></p-progressSpinner>
      <h4 class="mb-2">Cargando resumen</h4>
      <p class="text-muted">Obteniendo datos del inventario...</p>
    </div>
  </p-card>

  <!-- Estado Vacío -->
  <p-card *ngIf="!loading && !resumenGeneral" styleClass="empty-panel text-center">
    <div class="py-6">
      <p-avatar
        icon="pi pi-chart-bar"
        size="xlarge"
        styleClass="mb-3"
        [style]="{'background-color': 'var(--surface-300)', 'color': 'var(--surface-600)'}">
      </p-avatar>
      <h4 class="mb-3">No hay datos disponibles</h4>
      <p class="text-muted mb-4">
        Selecciona una fecha y presiona "Actualizar" para ver el resumen del inventario.
      </p>
      <p-button
        label="Cargar Datos"
        icon="pi pi-refresh"
        (onClick)="cargarResumenGeneral()"
        styleClass="p-button-primary">
      </p-button>
    </div>
  </p-card>

  <p-toast></p-toast>
</div>
